---
layout: post
title: "시계열 분석 시리즈 (1): 정상성 (Stationarity) 뽀개기"
date:
categories: []
tag: []
comments: true
photos:
    - "../../images/casual-title.png"
---


* 이번 포스팅은 [실전 시계열 분석: 통계와 머신러닝을 활용한 예측 기법](http://www.yes24.com/Product/Goods/98576347) 책과 [Forecasting: Principles and Practice](https://otexts.com/fppkr/)책을 기반으로 정상성에 대해 자세하게 정리하였습니다.

---
## 정상성: 시계열에 필요한 가정

시계열 자료를 분석하는 통계적인 방법에서 빠질 수 없는 개념은 **정상성 (Stationarity)**입니다. 그 이유는 시계열 분석을 할 때 필요한 가정이 **정상성**이기 때문이죠. 마치 회귀 분석을 할 때 오차의 정규성, 등분산성을 만족해야 그 회귀 분석 결과를 믿을 수 있는 것처럼, 시계열 분석을 할 때에도 정상성을 만족해야 분석 결과에 대해 신뢰할 수 있습니다.

그러나, 실제로 시계열 분석을 할 때 정상성이 왜 필요한지도 모르겠고, 어떻게 해야 정상성을 만족시킬 수 있는지, 어떻게 해야 정상성을 띤다고 말할 수 있는지 애매할 때가 있습니다. 
따라서, 이 포스트를 통해서 
* 정상성을 먼저 정의하고,
* 정상성을 만족시킬 수 있는 방법인 차분과 로그 변환에 대해 설명하고
* 정상성을 만족시키는지 파악하기 위한 방법으로 ACF (Auto Correlation Function)을 통해 파악하는 방법과, 단위근 검정을 통해 파악하는 방법에 대해 정리하고자 합니다.


---
### 정상성의 정의

> 쉽게 말해 정상성은 과거와 현재와 미래의 분포가 같아야 함을 의미합니다.

![](../../images/stationarity-examples.png)
여기서 정상성을 가지는 시계열은 (b)와 (g)뿐입니다.
{.:figure}

정상성을 가진 시계열을 직관적으로 파악하려면, 연필을 들고 **지그재그 모양을 수평으로 막 그리면** 그게 바로 정상성입니다! 위 그림에서 보면 (b)와 (g)가 그에 해당합니다. 
* (d),(h)는 계절성이 보이기 때문에 정상성을 띠지 않습니다.
* (a),(c),(e),(f)는 어떤 특정한 트렌드 (추세)가 있기 때문에 정상성을 띠지 않습니다.
* (i)는 계절성도, 트렌드도 보이며 심지어 분산도 시간에 따라 커지는 형태이므로 정상성을 띠지 않습니다.

결과적으로 정상성은 어떤 특정한 주기로 반복하는 계절성이나 위로 혹은 아래로 가는 트렌드가 없어야 하며, 분산도 커지면 안되는 것이라 유추 할 수 있습니다. 즉, **시간에 무관하게 과거, 현재, 미래의 분포가 같아야 한다**는 의미입니다.

그렇다면, 정상성 (Stationarity)을 더 엄밀히 정의해봅시다.

> 정상성이란 시계열의 평균과 분산이 일정하고, 특정한 트렌드 (추세)가 존재하지 않는 성질을 의미합니다.

정상성은 강한 정상성 (Strong Stationarity)와 약한 정상성 (Weak Stationarity)로 정의가 되는데, 일반적으로 약한 정상성만 만족해도 분석이 타당하다고 보기 때문에,
약한 정상성에 대해서만 더 자세히 알아보겠습니다.

약한 정상성을 수학적으로 더 엄밀하게 정의한다면 다음의 세 가지 조건을 만족해야 합니다.
1. 임의의 $t$에 대해서 $E(X_t) = \mu$
2. 임의의 $t$에 대해서 $Var(X_t) < \infty$
3. 임의의 $t$, $h$에 대하여 $Cov(X_{t+h}, X_t) = \gamma(h)$

3번에서 $\gamma(h)$는 자기공분산 함수 (Autocovariance Function, ACVF)라 불리우는데, 공분산이 시점 $t$에 의존하지 않고, 시간의 차이인 $h$에만 의존함을 의미합니다.

예를 들어, A 주식이 정상성을 띤다고 가정합시다.
이 주가의 평균이 3천원이고, 임의의 시점을 $t$ = 2020년 1월 3일이라 치면
* 1. 2020년 1월 3일의 주가의 평균이 $\mu = 3천 원$이고
* 2. 2020년 1월 3일의 주가의 분산이 유한하며 (= 극단치로 터지지 않고)
* 3. 2020년 1월 3일의 주가와, 그로부터 5일 뒤인 2020년 1월 8일의 주가 간의 공분산이 $\gamma(5)$임을 의미합니다.

---
### 정상성이 중요한 이유

정상성이 중요한 이유는 시계열의 평균과 분산이 일정해야 시계열 값을 예측할 수 있기 때문입니다. 시계열 분석에서는 "우리가 구한 시계열 자료"가 어떤 시간에 따른 **확률 과정 (stochastic process)**에서 실현된 값이라고 보는데요. 

확률 과정이라는 말이 어려우니 조금 더 익숙한 개념으로 돌아가봅시다. 고등학교 수학에서 확률을 배울 때  
$$
\bar{X} \sim N(\mu, \sigma^2 /n)
$$
인 성질을 이용해서 신뢰 구간도 구하고, 가설 검정도 했던 것을 기억하시나요?

여기서 $\bar{X}$는 우리가 얻은 $n$개의 데이터 (= 표본, samples) $X_1,X_2,\ldots,X_n$의 평균, 즉 표본 평균이고, $\mu$는 모 평균, $\sigma^2$은 모 분산에 해당합니다.
이는 **표본들의 평균이 일정한 평균과 분산을 가지는 정규분포를 따른다**는 의미이죠.

여기서 확장되어 확률 과정은 **시간별로 표시된 확률 변수의 집합**으로 정의가 됩니다. 즉, 각 시점 $t$에서의 값이 확률 분포 (예컨대, 위 예시처럼 각 시점에서의 값 (주가, 임금, 등등 우리가 관심있는 값) 이 정규분포를 따르는 것이죠)를 따른다고 보고, 이를 종합적으로 고려했을 때 시간 $t \in [0,\infty]$에서의 값들이 어떤 확률 분포를 따를 때 확률 과정이라 부를 수 있습니다. 

그런데, 우리가 얻은 데이터 (= 표본)에 대응되는 것이 우리가 얻은 시계열 자료이고, 이들은 일정한 평균과 분산을 가진 확률 과정 (stochastic process)을 따른다고 가정해야만 시계열 예측을 할 수 있습니다. 가령, 오늘의 주가가 3천 원인데, 이 주가는 이상적인 천상의 주가 그래프에서 여러 개를 표본 선출하여 만든 수치들 (Ex. 2000원, 2500원, 5000원, .., 3000원)의 평균 값이라고 볼 수 있는 것이죠.

만약 시간의 흐름에 따라서 이 확률 분포가 크게 변동한다면, 그 실현값들의 평균이나 분산 등 모멘트가 의미가 없기 때문에 적어도 이 평균과 분산이 우리가 다루고자 하는 확률 과정을 설명하기에 문제가 없도록 하기 위해 필요한 조건이 바로 정상성입니다.

이런 정상성을 가진 시계열은 평균으로 회귀하려는 특징 (mean)을 가지고 있습니다. 즉, 어떤 시점에서 평균을 크게 벗어났다면, 조만간 다시 평균으로 돌아가려는 성향을 가지고 있습니다.

**결과적으로 정상성을 띄는 확률 과정을 그림으로 표현하면 다음과 같습니다.**

![](../../images/stationarity-stochasticprocess.png)

회색 선이 시계열 자료라면, 빨간색 선처럼 각 시점에서 확률 분포를 가지고, 이들의 평균과 분산이 동일한 분포이므로 확률 과정이 정상성을 띤다 볼 수 있습니다.

---
## 정상성을 만족시키기 위한 두 가지 방법

보통 시계열 자료는 정상성을 띠지 않는 자료가 많습니다. 생각해보면 주가도 시간에 따라 증가하는 모습을 보이고, 분산도 언제는 작았다가 언제는 크기도 하기 때문에 정상성을 띠지 않는게 대부분이죠.

![](../../images/stationarity-stockprices.png)

위 그림은 네이버 주가의 월봉 그래프로, 평균이 일정하지 않고 올라가는 추세를 보이고, 월마다 변하는 정도도 제각각인 것을 보아 분산도 다름을 유추할 수 있습니다. 즉, 정상성을 띠지 않습니다.

이렇게 시계열 자료가 정상성을 띠지 않으면, AR, MA, ARIMA 등 전통적인 시계열 분석 방법들을 사용하기 어렵기 때문에 시계열 자료들에 어떤 **변환**을 취해 정상성을 띠도록 만들어야 합니다.
바로 **차분 (Differencing)**과 **로그 변환**입니다.

---
### 차분 (Differencing)

> 차분은 $t$시점과 $t-1$시점의 값의 차이를 구하는 것을 의미합니다.

![](../../images/stationarity-examples.png)
여기서 정상성을 가지는 시계열은 (b)와 (g)뿐입니다.
{.:figure}

다시 위 그림에서 (a)의 구글의 주식 가격이 정상성을 나타내는 시계열이 아니었지만, (b)는 구글의 주식 가격의 일별 변화는 정상성을 나타냈다는 것을 주목합시다. 즉, 연이은 관측값의 차이를 계산하는 차분을 취하면, 그 차이값들의 평균은 일정하기 때문에 정상성을 띠게 되는 것입니다.

차분을 수식을 통해 정의하면 다음과 같습니다.

$$
\Delta t = y_t - y_{t-1}
$$

첫 번째 관측값에 대한 차분 $\deta y_1$을 구할 수 없기 때문에, 차분값들은 $T-1$개의 값만 가지게 됩니다.

#### 2차 차분

가끔 차분을 해도 시계열의 정상성이 만족되지 않는 경우도 있습니다. 그럴 경우, 정상성을 나타내는 시계열을 얻기 위해 다음과 같이 한 번 더 차분을 구하는 작업이 필요할 수도 있습니다.
$$
\begin{aligned}
\Delta t - \Delta y{t-1}
&= (y_t - y_{t-1}) - (y_{t-1} - y_{t-2})\\
& = y_t - 2y_{t-1} + y_{t-2}
\end{aligned}
$$

이 경우 2차 차분값은 $T-2$개의 값을 가지게 됩니다. 결국, 2차 차분은 원본 시계열 데이터의 "변화에서 나타나는 변화"를 모델링하게 되는 셈입니다. 실제 상황에서는 2차 차분 이상으로 구하는 경우는 거의 일어나지 않는다 합니다.


#### 계절성 차분

계절성 차분은 관측치와, 같은 계절의 이전 관측값과의 차이를 말합니다. 따라서 다음과 같이 정의가 됩니다.

$$
y_{t} - y_{t-m}
$$

여기서 $m$은 주기에 해당합니다. 즉 $m=12$이고 월별로 집계된 값이라면, 올해 1월의 값 - 작년 1월의 값, 올해 2월의 값 - 작년 2월의 값, ... 이 되겠죠.

---
### 로그 변환

> 로그 변환을 통해 정상성을 띠지 않는 시계열 자료의 분산을 줄일 수 있습니다.
 
정상성을 만족시키는 두 번째 방법으로 로그 변환을 고려할 수 있습니다. 말 그대로 값에 시계열 값에 로그를 취하면 됩니다.

$$
y_t \rightarrow \log (y_t)
$$

로그 변환은 특히 값의 변동 자체가 큰 경우 (= 분산이 큰 경우) 고려할 수 있는 방법입니다. 또한, GDP와 같은 많은 경제 시게열 자료가 근사적으로 **지수적인 성장**을 나타내고 있는 경우가 많기 때문에 이런 시계열 자료에 로그를 취해 선형적인 값으로 바꿔주는 효과 또한 있습니다.

그러나, 로그 변환을 통해 어떤 시계열 자료가 선형적인 추세를 보인다면 시간이 지남에 따라 평균이 일정하지 않고 증가한다는 뜻이기 때문에, 이 또한 정상성을 띠지 않는 문제가 있습니다. 

그럼 뭐야? 라고 생각이 들겠지만 다음 장에서 그 해답을 찾을 수 있습니다.

---
### 로그 변환 + 차분 

![](../../images/stationarity-ppap.jpg)

그래서 저희는 PPAP 전법이 필요합니다. 즉, 
* 로그 변환을 통해서 먼저 분산을 안정화시키고, 지수적인 값을 가지는 시계열을 선형적으로 바꿔준 다음,
* 로그 변환된 시계열 값에 차분을 취해 정상성을 만족시키도록 만드는 것입니다.

시간에 따라 어떤 시계열이 선형적으로 증가한다는 뜻은 즉, 그 시간에 따른 **증가분 (차분)이 일정하다**는 것이기 때문에, 로그 변환된 시계열에 차분까지 해주면 정상성을 만족시킬 수 있는 것입니다.

더 놀라운 것은 **로그의 차분값이 증가율의 근사값**이라는 것이 알려져 있습니다.
즉, 저희가 PPAP 전법을 통해 로그의 차분값을 다음과 같이 정의한다면,

$$
\delta \log(y_t) = \log y_t - \log y_{t-1}
$$

이 값은 $y_{t-1}$에서 $y_t$로의 증가율로 근사할 수 있습니다.

$$
\delta \log(y_t) = \log y_t - \log y_{t-1} \simeq \frac{y_t - y_{t-1}}{y_{t-1}}
$$

왜 놀랍냐면, 해석 상 이점이 있기 때문입니다. 가령 "GDP의 로그의 차분값이 AR (1)과정을 따릅니다"라는 말보다 "GDP의 증가율이 AR(1) 과정을 따릅니다"가 직관적으로 잘 와닿지 않나요?


실제 경제 지수에서 이를 잘 설명하는 지표는 소비자 물가 지수 (CPI; Customer Price Index)입니다.

![](../../images/stationarity-cpi.png)
미국의 CPI와 CPI 변화율, 출처: [`[link]`](https://en.wikipedia.org/wiki/Consumer_price_index)
{.:figure}

위 그림에서 보면 파란색 선이 CPI, 빨간색 선이 CPI의 변화율을 나타냅니다. CPI는 장기적으로 봤을 때 매우 강한 장기 추세를 가집니다. 이에 비해 변화율은 CPI보다는 어떤 추세를 보이고 있지 않습니다.
$$
\frac{CPI_{t} -CPI_{t-1}}{CPI_{t-1}}
$$
로 정의가 됩니다. 즉, 이 값은 로그 차분값과 비슷하기 때문에 

$$
\frac{CPI_{t} -CPI_{t-1}}{CPI_{t-1}} \simeq \delta \log (CPI_{t})
$$
로 간주할 수 있습니다. 그러나 이 값도 분산으로 보면 과거에는 분산이 매우 컸으나, 현재 와서는 또 분산이 안정적으로 보이고 있어서 정상성을 띠고 있다고 보기 어렵습니다.

![](../../images/stationarity-rosa.jpg)

"PPAP 전법이 통하지 않는데, 그럼 어떡하냐"하신다면 대답해드리는게 인지 상정!
정답은 로그 차분값에 또 차분을 할 수 있습니다 (즉 2차 차분을 시행합니다).

CPI의 연 변화율은 인플레이션율과 같은 의미인데, 이 인플레이션율의 연간 차이를 구하면 정말 정상성을 띠게 됩니다. 즉, 수식으로 표현하면 $\Delta Inf_{t}$가 정상성을 띠게 됩니다. 

$$
\begin{aligned}
Inf_t &= \frac{CPI_{t} -CPI_{t-1}}{CPI_{t-1}} \simeq \delta \log (CPI_{t}\\
\Delta Inf_t &=  Inf_t - Inf_{t-1}\\
\end{aligned}
$$

---
## 정상성 검증을 위한 두 가지 방법


### ACF로 정상성 파악하기

휴, 네 이제 정상성을 띠도록 하는 두 가지 방법에 대해 알아보았는데요. 실제로 이렇게 해줬을 때 


---
## 단위근 검정 (Unit Root Test)으로 정상성 파악하기



